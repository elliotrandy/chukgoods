{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>CHUKGOODS</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="w-full pt-20 min-h-screen bg-gradient-to-b from-slate-50 to-slate-100" data-user-id="{% if user.is_authenticated %}{{ user.id }}{% else %}null{% endif %}">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    <!-- Header Section -->
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-slate-900 mb-2 tracking-tight">Browse Products</h1>
      <p class="text-slate-600">Find the latest items curated for football enthusiasts</p>
    </header>

    <!-- Django Messages -->
    {% if messages %}
    <div class="messages mt-6 space-y-2">
      {% for message in messages %}
        <div class="message-item px-4 py-3 rounded-md text-sm border {% if message.tags == 'success' %}bg-blue-50 border-blue-200 text-blue-700{% elif message.tags == 'error' %}bg-red-50 border-red-200 text-red-700{% else %}bg-slate-50 border-slate-200 text-slate-700{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Filter Section -->
    <section class="mb-8 bg-white/80 backdrop-blur rounded-xl border border-slate-200 p-4 sm:p-5">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex flex-wrap items-center gap-3">
          <a href="?"
            class="px-4 py-2 rounded-lg font-medium transition-colors border border-slate-300
                    {% if request.GET.filter == 'all' or not request.GET.filter %}
                      bg-blue-600 text-white
                    {% else %}
                      bg-white text-slate-700
                    {% endif %}">
            All Products
          </a>
          <a href="?filter=my"
            class="px-4 py-2 rounded-lg font-medium transition-colors border border-slate-300
                    {% if request.GET.filter == 'my' %}
                      bg-blue-600 text-white
                    {% else %}
                      bg-white text-slate-700
                    {% endif %}">
            My Products
          </a>
        </div>

        {% if user.is_authenticated %}
          <div class="text-sm text-slate-500">
            Last login: {{ last_login }}
          </div>
        {% endif %}
      </div>
    </section>

    <!-- Product Grid -->
    <div class="flex items-center justify-between mb-6">
      <button id="refresh-btn" class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Refresh
      </button>
      {% if user.is_authenticated %}
        <button id="create-btn" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
          Add Product
        </button>
      {% endif %}
    </div>

    <div id="loading-state" class="hidden bg-white/80 backdrop-blur rounded-xl border border-slate-200 p-10 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p class="text-slate-600">Loading products...</p>
    </div>

    <div id="empty-state" class="hidden bg-white/80 backdrop-blur rounded-xl border border-slate-200 p-10 text-center">
      <div class="mx-auto mb-4 h-20 w-20 rounded-2xl flex items-center justify-center">
        <img src="{% static 'image/no-product.png' %}" alt="No products available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-semibold text-slate-900 mb-2">No products found</h3>
      <p class="text-slate-600 mb-6">Be the first to add a product to the catalog.</p>
    </div>

    <div id="error-state" class="hidden bg-white/80 backdrop-blur rounded-xl border border-red-200 p-10 text-center">
      <div class="mx-auto mb-4 h-20 w-20 rounded-2xl bg-red-100 flex items-center justify-center">
        <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-slate-900 mb-2">Error loading products</h3>
      <p class="text-slate-600 mb-6" id="error-message">Something went wrong. Please try again.</p>
      <button id="retry-btn" class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors">
        Try Again
      </button>
    </div>

    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
      <!-- Products will be loaded here -->
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Create Product Modal -->
<div id="create-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Add New Product</h3>
        <button id="close-create-modal" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form id="create-form">
        {% csrf_token %}
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
            <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
            <input type="number" name="price" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Thumbnail URL</label>
            <input type="url" name="thumbnail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <select name="category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="apparel">Apparel</option>
              <option value="footwear">Footwear</option>
              <option value="accessories">Accessories</option>
              <option value="equipment">Equipment</option>
              <option value="fan gear">Fan Gear</option>
            </select>
          </div>
          <div class="flex items-center">
            <input type="checkbox" name="is_featured" id="create-featured" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <label for="create-featured" class="ml-2 block text-sm text-gray-900">Featured Product</label>
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" id="cancel-create" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Edit Product</h3>
        <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form id="edit-form">
        {% csrf_token %}
        <input type="hidden" name="id" id="edit-id">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
            <input type="text" name="name" id="edit-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
            <input type="number" name="price" id="edit-price" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea name="description" id="edit-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Thumbnail URL</label>
            <input type="url" name="thumbnail" id="edit-thumbnail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <select name="category" id="edit-category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="apparel">Apparel</option>
              <option value="footwear">Footwear</option>
              <option value="accessories">Accessories</option>
              <option value="equipment">Equipment</option>
              <option value="fan gear">Fan Gear</option>
            </select>
          </div>
          <div class="flex items-center">
            <input type="checkbox" name="is_featured" id="edit-featured" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <label for="edit-featured" class="ml-2 block text-sm text-gray-900">Featured Product</label>
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" id="cancel-edit" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">Cancel</button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Delete Product</h3>
        <button id="close-delete-modal" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <p class="text-gray-600 mb-6">Are you sure you want to delete this product? This action cannot be undone.</p>
      <div class="flex justify-end space-x-3">
        <button id="cancel-delete" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200">Cancel</button>
        <button id="confirm-delete" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Global variables
  let currentFilter = 'all';
  let deleteProductId = null;
  let currentUserId;
  const userIdData = document.querySelector('[data-user-id]').dataset.userId;
  currentUserId = userIdData !== 'null' ? parseInt(userIdData) : null;


  // Load products
  async function loadProducts(filter = 'all') {
    currentFilter = filter;
    const grid = document.getElementById('product-grid');
    const loading = document.getElementById('loading-state');
    const empty = document.getElementById('empty-state');
    const error = document.getElementById('error-state');

    // Show loading
    grid.innerHTML = '';
    loading.classList.remove('hidden');
    empty.classList.add('hidden');
    error.classList.add('hidden');

    try {
      const response = await fetch(`?filter=${filter}`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (!response.ok) throw new Error('Failed to load products');

      const data = await response.json();
      loading.classList.add('hidden');

      if (data.products.length === 0) {
        empty.classList.remove('hidden');
      } else {
        data.products.forEach(product => {
          const card = createProductCard(product);
          grid.appendChild(card);
        });
      }
    } catch (err) {
      loading.classList.add('hidden');
      error.classList.remove('hidden');
      document.getElementById('error-message').textContent = err.message;
    }
  }

  // Create product card
  function createProductCard(product) {
    const card = document.createElement('article');
    card.className = 'bg-white/80 backdrop-blur rounded-xl border border-slate-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden';
    card.innerHTML = `
      <div class="aspect-[16/9] relative overflow-hidden">
        ${product.thumbnail ? `<img src="${product.thumbnail}" alt="${product.name}" class="w-full h-full object-cover">` : '<div class="w-full h-full bg-slate-200"></div>'}
        ${product.category_display ? `<div class="absolute top-3 left-3"><span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-600 text-white">${product.category_display}</span></div>` : ''}
        <div class="absolute top-3 right-3 flex space-x-2">
          ${product.is_featured ? '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-50 text-blue-700 ring-1 ring-blue-200">Featured</span>' : ''}
        </div>
      </div>
      <div class="p-5">
        <div class="mb-3">
          <span class="text-lg font-bold text-blue-600">Rp${product.price.toLocaleString()}</span>
        </div>
        <h3 class="text-lg font-semibold text-slate-900 mb-2 leading-tight line-clamp-2">${product.name}</h3>
        <p class="text-slate-600 text-sm leading-relaxed line-clamp-3 mb-4">${product.description}</p>
        <div class="flex items-center justify-between pt-4 border-t border-slate-100">
          <a href="/product/${product.id}/" class="text-blue-600 hover:text-blue-700 font-medium text-sm transition-colors">View details →</a>
          ${product.user_id == currentUserId ? `
          <div class="flex items-center gap-3">
            <button onclick="editProduct('${product.id}')" class="text-slate-600 hover:text-slate-800 text-sm transition-colors">Edit</button>
            <button onclick="deleteProduct('${product.id}')" class="text-rose-600 hover:text-rose-700 text-sm transition-colors">Delete</button>
          </div>
          ` : ''}
        </div>
      </div>
    `;
    return card;
  }

  // Modal functions
  function showModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
  }

  function hideModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
  }

  // Create product
  document.getElementById('create-btn').addEventListener('click', () => showModal('create-modal'));
  document.getElementById('close-create-modal').addEventListener('click', () => hideModal('create-modal'));
  document.getElementById('cancel-create').addEventListener('click', () => hideModal('create-modal'));

  document.getElementById('create-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);

    try {
      const response = await fetch('/create-product/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      if (result.success) {
        hideModal('create-modal');
        e.target.reset();
        loadProducts(currentFilter);
        showToast('Product created successfully', 'success');
      } else {
        // Handle errors
        showToast('Failed to create product', 'error');
      }
    } catch (err) {
      showToast('Error creating product', 'error');
    }
  });

  // Edit product
  function editProduct(id) {
    // Fetch product data and populate form
    fetch(`/json/${id}/`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
      const product = data[0].fields;
      document.getElementById('edit-id').value = id;
      document.getElementById('edit-name').value = product.name;
      document.getElementById('edit-price').value = product.price;
      document.getElementById('edit-description').value = product.description;
      document.getElementById('edit-thumbnail').value = product.thumbnail;
      document.getElementById('edit-category').value = product.category;
      document.getElementById('edit-featured').checked = product.is_featured;
      showModal('edit-modal');
    });
  }

  document.getElementById('close-edit-modal').addEventListener('click', () => hideModal('edit-modal'));
  document.getElementById('cancel-edit').addEventListener('click', () => hideModal('edit-modal'));

  document.getElementById('edit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    const id = data.id;

    try {
      const response = await fetch(`/product/${id}/edit`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      if (result.success) {
        hideModal('edit-modal');
        loadProducts(currentFilter);
        showToast('Product updated successfully', 'success');
      } else {
        showToast('Failed to update product', 'error');
      }
    } catch (err) {
      showToast('Error updating product', 'error');
    }
  });

  // Delete product
  function deleteProduct(id) {
    deleteProductId = id;
    showModal('delete-modal');
  }

  document.getElementById('close-delete-modal').addEventListener('click', () => hideModal('delete-modal'));
  document.getElementById('cancel-delete').addEventListener('click', () => hideModal('delete-modal'));

  document.getElementById('confirm-delete').addEventListener('click', async () => {
    if (!deleteProductId) return;

    try {
      const response = await fetch(`/product/${deleteProductId}/delete`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      const result = await response.json();
      if (result.success) {
        hideModal('delete-modal');
        loadProducts(currentFilter);
        showToast('Product deleted successfully', 'success');
      } else {
        showToast('Failed to delete product', 'error');
      }
    } catch (err) {
      showToast('Error deleting product', 'error');
    }
    deleteProductId = null;
  });

  // Filter buttons
  document.querySelectorAll('a[href="?"] , a[href*="filter"]').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const url = new URL(link.href, window.location.origin);
      const filter = url.searchParams.get('filter') || 'all';
      loadProducts(filter);
      // Update active state
      document.querySelectorAll('a[href="?"] , a[href*="filter"]').forEach(l => {
        l.classList.remove('bg-blue-600', 'text-white', 'bg-white', 'text-slate-700');
        l.classList.add('bg-white', 'text-slate-700');
      });
      link.classList.remove('bg-white', 'text-slate-700');
      link.classList.add('bg-blue-600', 'text-white');
    });
  });

  // Refresh button
  document.getElementById('refresh-btn').addEventListener('click', () => loadProducts(currentFilter));

  // Retry button
  document.getElementById('retry-btn').addEventListener('click', () => loadProducts(currentFilter));


  // Logout function
  function logoutUser() {
    fetch('/logout/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        showToast('Logout successful', 'success');
        setTimeout(() => window.location.href = '/login/', 1000);
      } else {
        showToast('Logout failed', 'error');
      }
    })
    .catch(err => {
      showToast('Error logging out', 'error');
    });
  }

  // Load products on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
    // Show toast for messages
    const messageElements = document.querySelectorAll('.messages div');
    messageElements.forEach(el => {
      const type = el.classList.contains('text-blue-700') ? 'success' : el.classList.contains('text-red-700') ? 'error' : 'info';
      showToast(el.textContent.trim(), type);
      el.remove();
    });
  });
</script>
{% endblock content %}
